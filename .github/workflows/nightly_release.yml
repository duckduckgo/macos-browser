name: Make Nightly Release

on: 
  #schedule:
  #  - cron: '0 2 * * *' # Run nightly at 7pm ET  
  push:
    branches:
      - daniel/nightly
  workflow_dispatch: 
    inputs:
      run:
        description: 'Create Nightly Build'
        required: false 
  workflow_call:
    secrets:
      BUILD_CERTIFICATE_BASE64:
        required: true
      P12_PASSWORD:
        required: true
      KEYCHAIN_PASSWORD:
        required: true
      REVIEW_PROVISION_PROFILE_BASE64:
        required: true
      RELEASE_PROVISION_PROFILE_BASE64:
        required: true
      SSH_PRIVATE_KEY_FIND_IN_PAGE:
        required: true
      APPLE_API_KEY_BASE64:
        required: true
      APPLE_API_KEY_ID:
        required: true
      APPLE_API_KEY_ISSUER:
        required: true
      ASANA_ACCESS_TOKEN:
        required: true
      MM_HANDLES_BASE64:
        required: true
      MM_WEBHOOK_URL:
        required: true

jobs:
  export-notarized-app:

    name: Export Nightly Build

    runs-on: macos-13

    env:
      release-type: nightly
      create-dmg: false
      asana-task-url: 'https://app.asana.com/0/1201037661562251/1204480871838578/f'

    steps:     
    - name: Set Asana task URL
      if: env.asana-task-url
      env:
        ASANA_ACCESS_TOKEN: ${{ secrets.ASANA_ACCESS_TOKEN }}
      run: |
        # Source the asana.sh script to use _asana_create_subtask function
        source ./scripts/helpers/asana.sh

        echo "Asana task URL: ${{ env.asana-task-url }}"
        
        # Extract the parent task ID from the provided Asana task URL
        parent_task_url="${{ env.asana-task-url }}"
        parent_task_id="${parent_task_url##*/}"
        
        echo "Parent task ID: $parent_task_id"
        
        # Create a subtask using the provided parent task ID and desired subtask name with the date
        current_date=$(date +"%Y-%m-%d")
        subtask_name="Nightly Build - $current_date"
        subtask_url=$(_asana_create_subtask "$parent_task_id" "$subtask_name")
        
        echo "Asana subtask URL: $subtask_url"
        
        # Set the asana_task_url_arg environment variable with the new subtask URL
        echo "asana_task_url_arg=-a $subtask_url" >> $GITHUB_ENV

    - name: Get current date
      run: echo "CURRENT_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      
